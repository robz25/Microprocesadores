
as12, an absolute assembler for Motorola MCU's, version 1.2h

                        #include registers.inc
                        ; Memory maps and register equates
                        ; Choose one of DBUG12MAP (normal operation under DBUG12)
                        ;               EEPROMMAP  (DBUG12 in EEPROM mode)
                        ;               FLASHMAP   (Program loaded into Flash ROM)
0000                    DBUG12MAP equ 0        ; Memory mode is DBUG12MAP
                        ; EEPROMMAP equ 0         ; Memory mode is EEPROMMAP
                        #ifdef DBUG12MAP
0000                    REGBASE        equ        $0        ; register base
1000                    DATASTART equ        $1000        ; Start of data memory
2000                    DATAEND  equ        $2000        ; Stack pointer initial value (end of data RAM area)
2000                    PRSTART equ        $2000        ; Start of program memory (might be ROM)
3bff                    PREND        equ        $3BFF        ; End of program memory
                        
                        ; Functions in D-Bug12
ee84                    Getchar        equ        $EE84        ; Implemented in emulator
ee86                    Putchar equ        $EE86   ; Implemented in emulator
ee88                    Printf  equ     $EE88
ee8a                    GetCmdLine equ  $EE8A   ; FAR call
ee8e                    Sscanhex equ        $EE8E   ; FAR call
ee92                    Isxdigit equ    $EE92
ee94                    Toupper equ     $EE94
ee96                    Isalpha equ     $EE96
ee98                    Strlen  equ     $EE98
ee9a                    Strcpy  equ     $EE9A
ee9c                    Out2hex equ     $EE9C   ; FAR call
eea0                    Out4hex equ     $EEA0   ; FAR call
eea4                    SetUserVector equ $EEA4 ; No longer used
eea6                    WriteEEByte equ $EEA6   ; FAR call
eeaa                    EraseEE equ     $EEAA   ; FAR call
eeae                    ReadMem equ     $EEAE   ; FAR call
eeb2                    WriteMem equ    $EEB2   ; FAR call
                        
3e00                    VECTORTABLE equ $3E00        ; Vectors go here SHOULD ALSO INITIALIZE AT RUNTIME
0000                    STATICVECTORS equ 0        ; Define vectors statically (in "ROM")
0000                    INITIALIZEVECTORS equ 0        ; Initialize vectors at runtime
                        #endif
                        
                        #ifdef EEPROMMAP
                        REGBASE        equ        $0        ; register base MAY BE MOVED TO MAKE FULL EEPROM ACCESSABLE
                        DATASTART equ        $1000        ; Start of data memory
                        DATAEND  equ        $3E00        ; Stack pointer initial value (end of data RAM area)
                        PRSTART equ        $400        ; Start of program memory
                        PREND        equ        $FFF        ; End of program memory
                        
                        VECTORTABLE equ $3E00        ; Vectors go here -- MUST BE INITIALIZED AT RUNTIME
                        INITIALIZEVECTORS equ 0        ; Initialize vectors at runtime
                        #endif
                        
                        #ifdef FLASHMAP
                        REGBASE        equ        $0        ; register base MAY BE MOVED TO MAKE FULL EEPROM ACCESSABLE
                        DATASTART equ        $1000        ; Start of data memory
                        DATAEND  equ        $4000        ; Stack pointer initial value (end of data RAM area)
                        PRSTART equ        $8000        ; Start of program memory
                        ; Note -- there are problems using the current free assemblers with paged memory
                        ; Best bet is to use logical addresses $8000 up only, set page register to 3E,
                        ; Change S1 records for $8000-BFFF to S2 records for page 3E and S1 records for $C000-$EFFF to
                        ; page 3F. Program startup vector goes in EFFE, and needs to be iin page 3F so PPAGE can be changed. 
                        PREND        equ        $EF7F        ; End of program memory
                        
                        VECTORTABLE equ $EF80        ; Vectors go here -- MUST BE INITIALIZED STATICALLY
                        STATICVECTORS equ 0        ; Define vectors statically (in "ROM")
                        #endif
                        
                        
1000                    RAMSTART equ        DATASTART ; For compatibility
2000                    RAMEND equ        DATAEND   
                        
3e00                    UserRsrv0x80 equ (0*2)+VECTORTABLE
3e02                    UserRsrv0x82 equ (1*2)+VECTORTABLE
3e04                    UserRsrv0x84 equ (2*2)+VECTORTABLE
3e06                    UserRsrv0x86 equ (3*2)+VECTORTABLE
3e08                    UserRsrv0x88 equ (4*2)+VECTORTABLE
3e0a                    UserRsrv0x8a equ (5*2)+VECTORTABLE
3e0c                    UserPWMShDn equ (6*2)+VECTORTABLE
3e0e                    UserPortP equ (7*2)+VECTORTABLE
3e10                    UserMSCAN4Tx equ (8*2)+VECTORTABLE
3e12                    UserMSCAN4Rx equ (9*2)+VECTORTABLE
3e14                    UserMSCAN4Errs equ (10*2)+VECTORTABLE
3e16                    UserMSCAN4Wake equ (11*2)+VECTORTABLE
3e18                    UserMSCAN3Tx equ (12*2)+VECTORTABLE
3e1a                    UserMSCAN3Rx equ (13*2)+VECTORTABLE
3e1c                    UserMSCAN3Errs equ (14*2)+VECTORTABLE
3e1e                    UserMSCAN3Wake equ (15*2)+VECTORTABLE
3e20                    UserMSCAN2Tx equ (16*2)+VECTORTABLE
3e22                    UserMSCAN2Rx equ (17*2)+VECTORTABLE
3e24                    UserMSCAN2Errs equ (18*2)+VECTORTABLE
3e26                    UserMSCAN2Wake equ (19*2)+VECTORTABLE
3e28                    UserMSCAN1Tx equ (20*2)+VECTORTABLE
3e2a                    UserMSCAN1Rx equ (21*2)+VECTORTABLE
3e2c                    UserMSCAN1Errs equ (22*2)+VECTORTABLE
3e2e                    UserMSCAN1Wake equ (23*2)+VECTORTABLE
3e30                    UserMSCAN0Tx equ (24*2)+VECTORTABLE
3e32                    UserMSCAN0Rx equ (25*2)+VECTORTABLE
3e34                    UserMSCAN0Errs equ (26*2)+VECTORTABLE
3e36                    UserMSCAN0Wake equ (27*2)+VECTORTABLE
3e38                    UserFlash equ (28*2)+VECTORTABLE
3e3a                    UserEEPROM equ (29*2)+VECTORTABLE
3e3c                    UserSPI2 equ (30*2)+VECTORTABLE
3e3e                    UserSPI1 equ (31*2)+VECTORTABLE
3e40                    UserIIC equ (32*2)+VECTORTABLE
3e42                    UserDLC equ (33*2)+VECTORTABLE
3e44                    UserSCME equ (34*2)+VECTORTABLE
3e46                    UserCRG equ (35*2)+VECTORTABLE
3e48                    UserPAccBOv equ (36*2)+VECTORTABLE
3e4a                    UserModDwnCtr equ (37*2)+VECTORTABLE
3e4c                    UserPortH equ (38*2)+VECTORTABLE
3e4e                    UserPortJ equ (39*2)+VECTORTABLE
3e50                    UserAtoD1 equ (40*2)+VECTORTABLE
3e52                    UserAtoD0 equ (41*2)+VECTORTABLE
3e54                    UserSCI1 equ (42*2)+VECTORTABLE
3e56                    UserSCI0 equ (43*2)+VECTORTABLE
3e58                    UserSPI0 equ (44*2)+VECTORTABLE
3e5a                    UserPAccEdge equ (45*2)+VECTORTABLE
3e5c                    UserPAccOvf equ (46*2)+VECTORTABLE
3e5e                    UserTimerOvf equ (47*2)+VECTORTABLE
3e60                    UserTimerCh7 equ (48*2)+VECTORTABLE
3e62                    UserTimerCh6 equ (49*2)+VECTORTABLE
3e64                    UserTimerCh5 equ (50*2)+VECTORTABLE
3e66                    UserTimerCh4 equ (51*2)+VECTORTABLE
3e68                    UserTimerCh3 equ (52*2)+VECTORTABLE
3e6a                    UserTimerCh2 equ (53*2)+VECTORTABLE
3e6c                    UserTimerCh1 equ (54*2)+VECTORTABLE
3e6e                    UserTimerCh0 equ (55*2)+VECTORTABLE
3e70                    UserRTI equ (56*2)+VECTORTABLE
3e72                    UserIRQ equ (57*2)+VECTORTABLE
3e74                    UserXIRQ equ (58*2)+VECTORTABLE
3e76                    UserSWI equ (59*2)+VECTORTABLE
3e78                    UserTrap equ (60*2)+VECTORTABLE
                        
                        
                        *
                        *
                        *  HC12 i/o register locations (9s12dp256)
                        *
                        *
0000                    PORTA:          equ REGBASE+0   ;port a = address lines a8 - a15
0001                    PORTB:          equ REGBASE+1   ;port b = address lines a0 - a7
0002                    DDRA:           equ REGBASE+2   ;port a direction register
0003                    DDRB:           equ REGBASE+3   ;port b direction register
                        
0008                    PORTE:          equ REGBASE+8   ;port e = mode,irq and control signals
0009                    DDRE:           equ REGBASE+9   ;port e direction register
000a                    PEAR:           equ REGBASE+$a  ;port e assignments
000b                    MODE:           equ REGBASE+$b  ;mode register
000c                    PUCR:           equ REGBASE+$c  ;port pull-up control register
000d                    RDRIV:          equ REGBASE+$d  ;port reduced drive control register
000e                    EBICTL:                equ REGBASE+$e  ;e stretch control
                        
0010                    INITRM:         equ REGBASE+$10 ;ram location register
0011                    INITRG:         equ REGBASE+$11 ;register location register
0012                    INITEE:         equ REGBASE+$12 ;eeprom location register
0013                    MISC:           equ REGBASE+$13 ;miscellaneous mapping control
0014                    MTST0:          equ REGBASE+$14 ; reserved
0015                    ITCR:           equ REGBASE+$15 ;interrupt test control register
0016                    ITEST:          equ REGBASE+$16 ;interrupt test register
0017                    MTST1:          equ REGBASE+$17 ; reserved
                        
001a                    PARTIDH:        equ REGBASE+$1a ;part id high
001b                    PARTIDL:        equ REGBASE+$1b ;part id low
001c                    MEMSIZ0:        equ REGBASE+$1c ;memory size
001d                    MEMSIZ1:        equ REGBASE+$1d ;memory size
001e                    IRQCR:          equ REGBASE+$1e ;interrupt control register
001e                    INTCR:          equ REGBASE+$1e ;interrupt control register (old name)
001f                    HPRIO:          equ REGBASE+$1f ;high priority reg
                        
0028                    BKPCT0:         equ REGBASE+$28 ;break control register
0029                    BKPCT1:         equ REGBASE+$29 ;break control register
002a                    BKP0X:          equ REGBASE+$2a ; break 0 index register
002b                    BKP0H:          equ REGBASE+$2b ; break 0 pointer high
002c                    BRP0L:          equ REGBASE+$2c ; break 0 pointer low
002d                    BKP1X:          equ REGBASE+$2d ; break 1 index register
002e                    BKP1H:          equ REGBASE+$2e ; break 1 pointer high
002f                    BRP1L:          equ REGBASE+$2f ; break 1 pointer low
0030                    PPAGE:                equ REGBASE+$30 ;program page register
                        
0032                    PORTK:                equ REGBASE+$32 ;port k data
0033                    DDRK:                equ REGBASE+$33 ;port k direction
                        
0034                    SYNR:           equ REGBASE+$34 ; synthesizer / multiplier register
0035                    REFDV:          equ REGBASE+$35 ; reference divider register
0036                    CTFLG:          equ REGBASE+$36 ; reserved
0037                    CRGFLG:         equ REGBASE+$37 ; pll flags register
0038                    CRGINT:         equ REGBASE+$38 ; pll interrupt register
0039                    CLKSEL:         equ REGBASE+$39 ; clock select register
003a                    PLLCTL:         equ REGBASE+$3a ; pll control register
003b                    RTICTL:         equ REGBASE+$3b ;real time interrupt control
003c                    COPCTL:         equ REGBASE+$3c ;watchdog control
003d                    FORBYP:         equ REGBASE+$3d ;
003e                    CTCTL:          equ REGBASE+$3e ;
003f                    ARMCOP:         equ REGBASE+$3f ;cop reset register
                        
0040                    TIOS:           equ REGBASE+$40 ;timer input/output select
0041                    CFORC:          equ REGBASE+$41 ;timer compare force
0042                    OC7M:           equ REGBASE+$42 ;timer output compare 7 mask
0043                    OC7D:           equ REGBASE+$43 ;timer output compare 7 data
0044                    TCNT:           equ REGBASE+$44 ;timer counter register hi
                        *TCNT:          equ REGBASE+$45 ;timer counter register lo
0046                    TSCR:           equ REGBASE+$46 ;timer system control register (Old Name)
0046                    TSCR1:          equ REGBASE+$46 ;timer system control register
0047                    TTOV:           equ REGBASE+$47 ;reserved
0048                    TCTL1:          equ REGBASE+$48 ;timer control register 1
0049                    TCTL2:          equ REGBASE+$49 ;timer control register 2
004a                    TCTL3:          equ REGBASE+$4a ;timer control register 3
004b                    TCTL4:          equ REGBASE+$4b ;timer control register 4
004c                    TMSK1:          equ REGBASE+$4c ;timer interrupt mask 1 (Old Name)
004c                    TIE:            equ REGBASE+$4c ;timer interrupt mask 1
004d                    TMSK2:          equ REGBASE+$4d ;timer interrupt mask 2 (Old Name)
004d                    TSCR2:          equ REGBASE+$4d ;timer interrupt mask 2
004e                    TFLG1:          equ REGBASE+$4e ;timer flags 1
004f                    TFLG2:          equ REGBASE+$4f ;timer flags 2
0050                    TC0:            equ REGBASE+$50 ;timer capture/compare register 0
0052                    TC1:            equ REGBASE+$52 ;timer capture/compare register 1
0054                    TC2:            equ REGBASE+$54 ;timer capture/compare register 2
0056                    TC3:            equ REGBASE+$56 ;timer capture/compare register 3
0058                    TC4:            equ REGBASE+$58 ;timer capture/compare register 4
005a                    TC5:            equ REGBASE+$5a ;timer capture/compare register 5
005c                    TC6:            equ REGBASE+$5c ;timer capture/compare register 6
005e                    TC7:            equ REGBASE+$5e ;timer capture/compare register 7
0060                    PACTL:          equ REGBASE+$60 ;pulse accumulator controls
0061                    PAFLG:          equ REGBASE+$61 ;pulse accumulator flags
0062                    PACN3:          equ REGBASE+$62 ;pulse accumulator counter 3
0063                    PACN2:          equ REGBASE+$63 ;pulse accumulator counter 2
0064                    PACN1:          equ REGBASE+$64 ;pulse accumulator counter 1
0065                    PACN0:          equ REGBASE+$65 ;pulse accumulator counter 0
0066                    MCCTL:          equ REGBASE+$66 ;modulus down conunter control
0067                    MCFLG:          equ REGBASE+$67 ;down counter flags
0068                    ICPAR:          equ REGBASE+$68 ;input pulse accumulator control
0069                    DLYCT:          equ REGBASE+$69 ;delay count to down counter
006a                    ICOVW:          equ REGBASE+$6a ;input control overwrite register
006b                    ICSYS:          equ REGBASE+$6b ;input control system control
                        
006d                    TIMTST:         equ REGBASE+$6d ;timer test register
                        
0070                    PBCTL:          equ REGBASE+$70 ; pulse accumulator b control
0071                    PBFLG:          equ REGBASE+$71 ; pulse accumulator b flags
0072                    PA3H:           equ REGBASE+$72 ; pulse accumulator holding register 3
0073                    PA2H:           equ REGBASE+$73 ; pulse accumulator holding register 2
0074                    PA1H:           equ REGBASE+$74 ; pulse accumulator holding register 1
0075                    PA0H:           equ REGBASE+$75 ; pulse accumulator holding register 0
0076                    MCCNT:          equ REGBASE+$76 ; modulus down counter register
                        *MCCNTL:        equ REGBASE+$77 ; low byte
0078                    TCOH:           equ REGBASE+$78 ; capture 0 holding register
007a                    TC1H:           equ REGBASE+$7a ; capture 1 holding register
007c                    TC2H:           equ REGBASE+$7c ; capture 2 holding register
007e                    TC3H:           equ REGBASE+$7e ; capture 3 holding register
                        
0080                    ATD0CTL0:       equ REGBASE+$80 ;adc control 0 (reserved)
0081                    ATD0CTL1:       equ REGBASE+$81 ;adc control 1 (reserved)
0082                    ATD0CTL2:       equ REGBASE+$82 ;adc control 2
0083                    ATD0CTL3:       equ REGBASE+$83 ;adc control 3
0084                    ATD0CTL4:       equ REGBASE+$84 ;adc control 4
0085                    ATD0CTL5:       equ REGBASE+$85 ;adc control 5
0086                    ATD0STAT:       equ REGBASE+$86 ;adc status register hi
0086                    ATD0STAT0:      equ REGBASE+$86 ;adc status register hi
008b                    ATD0STAT1:      equ REGBASE+$8b ;adc status register lo
0088                    ATD0TEST:       equ REGBASE+$88 ;adc test (reserved)
                        *atd0test       equ REGBASE+$89 ;
                        
008d                    ATD0DIEN:        equ REGBASE+$8d ;
                        
008f                    PORTAD:         equ REGBASE+$8f ;port adc = input only
0090                    ADR00H:         equ REGBASE+$90 ;adc result 0 register
0092                    ADR01H:         equ REGBASE+$92 ;adc result 1 register
0094                    ADR02H:         equ REGBASE+$94 ;adc result 2 register
0096                    ADR03H:         equ REGBASE+$96 ;adc result 3 register
0098                    ADR04H:         equ REGBASE+$98 ;adc result 4 register
009a                    ADR05H:         equ REGBASE+$9a ;adc result 5 register
009c                    ADR06H:         equ REGBASE+$9c ;adc result 6 register
009e                    ADR07H:         equ REGBASE+$9e ;adc result 7 register
                        
00a0                    PWME:                equ REGBASE+$a0 ;pwm enable
00a1                    PWMPOL:         equ REGBASE+$a1 ;pwm polarity
00a2                    PWMCLK:         equ REGBASE+$a2 ;pwm clock select register
00a3                    PWMPRCLK:       equ REGBASE+$a3 ;pwm prescale clock select register
00a4                    PWMCAE:         equ REGBASE+$a4 ;pwm center align select register
00a5                    PWMCTL:         equ REGBASE+$a5 ;pwm control register
00a6                    PWMTST:         equ REGBASE+$a6 ;reserved
00a7                    PWMPRSC:        equ REGBASE+$a7 ;reserved
00a8                    PWMSCLA:        equ REGBASE+$a8 ;pwm scale a
00a9                    PWMSCLB:        equ REGBASE+$a9 ;pwm scale b
00aa                    PWMSCNTA:       equ REGBASE+$aa ;reserved
00ab                    PWMSCNTB:       equ REGBASE+$ab ;reserved
00ac                    PWMCNT0:        equ REGBASE+$ac ;pwm channel 0 counter
00ad                    PWMCNT1:        equ REGBASE+$ad ;pwm channel 1 counter
00ae                    PWMCNT2:        equ REGBASE+$ae ;pwm channel 2 counter
00af                    PWMCNT3:        equ REGBASE+$af ;pwm channel 3 counter
00b0                    PWMCNT4:        equ REGBASE+$b0 ;pwm channel 4 counter
00b1                    PWMCNT5:        equ REGBASE+$b1 ;pwm channel 5 counter
00b2                    PWMCNT6:        equ REGBASE+$b2 ;pwm channel 6 counter
00b3                    PWMCNT7:        equ REGBASE+$b3 ;pwm channel 7 counter
00b4                    PWMPER0:        equ REGBASE+$b4 ;pwm channel 0 period
00b5                    PWMPER1:        equ REGBASE+$b5 ;pwm channel 1 period
00b6                    PWMPER2:        equ REGBASE+$b6 ;pwm channel 2 period
00b7                    PWMPER3:        equ REGBASE+$b7 ;pwm channel 3 period
00b8                    PWMPER4:        equ REGBASE+$b8 ;pwm channel 4 period
00b9                    PWMPER5:        equ REGBASE+$b9 ;pwm channel 5 period
00ba                    PWMPER6:        equ REGBASE+$ba ;pwm channel 6 period
00bb                    PWMPER7:        equ REGBASE+$bb ;pwm channel 7 period
00bc                    PWMDTY0:        equ REGBASE+$bc ;pwm channel 0 duty cycle
00bd                    PWMDTY1:        equ REGBASE+$bd ;pwm channel 1 duty cycle
00be                    PWMDTY2:        equ REGBASE+$be ;pwm channel 2 duty cycle
00bf                    PWMDTY3:        equ REGBASE+$bf ;pwm channel 3 duty cycle
00c0                    PWMDTY4:        equ REGBASE+$c0 ;pwm channel 4 duty cycle
00c1                    PWMDTY5:        equ REGBASE+$c1 ;pwm channel 5 duty cycle
00c2                    PWMDTY6:        equ REGBASE+$c2 ;pwm channel 6 duty cycle
00c3                    PWMDTY7:        equ REGBASE+$c3 ;pwm channel 7 duty cycle
00c4                    PWMSDN:         equ REGBASE+$c4 ;pwm shutdown register
                        
00c8                    SC0BDH:         equ REGBASE+$c8 ;sci 0 baud reg hi byte
00c9                    SC0BDL:         equ REGBASE+$c9 ;sci 0 baud reg lo byte
00ca                    SC0CR1:         equ REGBASE+$ca ;sci 0 control1 reg
00cb                    SC0CR2:         equ REGBASE+$cb ;sci 0 control2 reg
00cc                    SC0SR1:         equ REGBASE+$cc ;sci 0 status reg 1
00cd                    SC0SR2:         equ REGBASE+$cd ;sci 0 status reg 2
00ce                    SC0DRH:         equ REGBASE+$ce ;sci 0 data reg hi
00cf                    SC0DRL:         equ REGBASE+$cf ;sci 0 data reg lo
                        
00d0                    SC1BDH:         equ REGBASE+$d0 ;sci 1 baud reg hi byte
00d1                    SC1BDL:         equ REGBASE+$d1 ;sci 1 baud reg lo byte
00d2                    SC1CR1:         equ REGBASE+$d2 ;sci 1 control1 reg
00d3                    SC1CR2:         equ REGBASE+$d3 ;sci 1 control2 reg
00d4                    SC1SR1:         equ REGBASE+$d4 ;sci 1 status reg 1
00d5                    SC1SR2:         equ REGBASE+$d5 ;sci 1 status reg 2
00d6                    SC1DRH:         equ REGBASE+$d6 ;sci 1 data reg hi
00d7                    SC1DRL:         equ REGBASE+$d7 ;sci 1 data reg lo
                        
00d8                    SPI0CR1:        equ REGBASE+$d8 ;spi 0 control1 reg
00d9                    SPI0CR2:        equ REGBASE+$d9 ;spi 0 control2 reg
00da                    SPI0BR:         equ REGBASE+$da ;spi 0 baud reg
00db                    SPI0SR:         equ REGBASE+$db ;spi 0 status reg hi
00dd                    SP0DR:          equ REGBASE+$dd ;spi 0 data reg  FOR COMPATIBILITY
00dd                    SPI0DR:          equ REGBASE+$dd ;spi 0 data reg
                        
00e0                    IBAD:                equ REGBASE+$e0 ;i2c bus address register
00e1                    IBFD:                equ REGBASE+$e1 ;i2c bus frequency divider
00e2                    IBCR:                equ REGBASE+$e2 ;i2c bus control register
00e3                    IBSR:                equ REGBASE+$e3 ;i2c bus status register
00e4                    IBDR:                equ REGBASE+$e4 ;i2c bus message data register
                        
00e8                    DLCBCR1:        equ REGBASE+$e8 ;bdlc control regsiter 1
00e9                    DLCBSVR:        equ REGBASE+$e9 ;bdlc state vector register
00ea                    DLCBCR2:        equ REGBASE+$ea ;bdlc control register 2
00eb                    DLCBDR:                equ REGBASE+$eb ;bdlc data register
00ec                    DLCBARD:        equ REGBASE+$ec ;bdlc analog delay register
00ed                    DLCBRSR:        equ REGBASE+$ed ;bdlc rate select register
00ee                    DLCSCR:                equ REGBASE+$ee ;bdlc control register
00ef                    DLCBSTAT:        equ REGBASE+$ef ;bdlc status register
                        
00f0                    SPI1CR1:        equ REGBASE+$f0 ;spi 1 control1 reg
00f1                    SPI1CR2:        equ REGBASE+$f1 ;spi 1 control2 reg
00f2                    SPI1BR:         equ REGBASE+$f2 ;spi 1 baud reg
00f3                    SPI1SR:         equ REGBASE+$f3 ;spi 1 status reg hi
00f5                    SPI1DR:          equ REGBASE+$f5 ;spi 1 data reg
00f5                    SP1DR:          equ REGBASE+$f5 ;spi 1 data reg   FOR COMPATIBILITY
                        
00f8                    SPI2CR1:        equ REGBASE+$f8 ;spi 2 control1 reg
00f9                    SPI2CR2:        equ REGBASE+$f9 ;spi 2 control2 reg
00fa                    SPI2BR:         equ REGBASE+$fa ;spi 2 baud reg
00fb                    SPI2SR:         equ REGBASE+$fb ;spi 2 status reg hi
00fd                    SPI2DR:         equ REGBASE+$fd ;spi 2 data reg
00fd                    SP2DR:          equ REGBASE+$fd ;spi 2 data reg   FOR COMPATIBILITY
                        
0100                    FCLKDIV:        equ REGBASE+$100 ;flash clock divider
0101                    FSEC:                equ REGBASE+$101 ;flash security register
                        
0103                    FCNFG:                equ REGBASE+$103 ;flash configuration register
0104                    FPROT:                equ REGBASE+$104 ;flash protection register
0105                    FSTAT:                equ REGBASE+$105 ;flash status register
0106                    FCMD:                equ REGBASE+$106 ;flash command register
                        
0110                    ECLKDIV:        equ REGBASE+$110 ;eeprom clock divider
                        
0113                    ECNFG:                equ REGBASE+$113 ;eeprom configuration register
0114                    EPROT:                equ REGBASE+$114 ;eeprom protection register
0115                    ESTAT:                equ REGBASE+$115 ;eeprom status register
0116                    ECMD:                equ REGBASE+$116 ;eeprom command register
                        
0120                    ATD1CTL0:       equ REGBASE+$120 ;adc1 control 0 (reserved)
0121                    ATD1CTL1:       equ REGBASE+$121 ;adc1 control 1 (reserved)
0122                    ATD1CTL2:       equ REGBASE+$122 ;adc1 control 2
0123                    ATD1CTL3:       equ REGBASE+$123 ;adc1 control 3
0124                    ATD1CTL4:       equ REGBASE+$124 ;adc1 control 4
0125                    ATD1CTL5:       equ REGBASE+$125 ;adc1 control 5
0126                    ATD1STAT0:      equ REGBASE+$126 ;adc1 status register hi
012b                    ATD1STAT1:      equ REGBASE+$12b ;adc1 status register lo
0128                    ATD1TEST:       equ REGBASE+$128 ;adc1 test (reserved)
                        *atd1test       equ REGBASE+$129 ;
                        
012d                    ATDDIEN:        equ REGBASE+$12d ;adc1 input enable register
                        
012f                    PORTAD1:        equ REGBASE+$12f ;port adc1 = input only
0130                    ADR10H:         equ REGBASE+$130 ;adc1 result 0 register
0132                    ADR11H:         equ REGBASE+$132 ;adc1 result 1 register
0134                    ADR12H:         equ REGBASE+$134 ;adc1 result 2 register
0136                    ADR13H:         equ REGBASE+$136 ;adc1 result 3 register
0138                    ADR14H:         equ REGBASE+$138 ;adc1 result 4 register
013a                    ADR15H:         equ REGBASE+$13a ;adc1 result 5 register
013c                    ADR16H:         equ REGBASE+$13c ;adc1 result 6 register
013e                    ADR17H:         equ REGBASE+$13e ;adc1 result 7 register
                        
0140                    CAN0CTL0:        equ REGBASE+$140 ;can0 control register 0
0141                    CAN0CTL1:        equ REGBASE+$141 ;can0 control register 1
0142                    CAN0BTR0:        equ REGBASE+$142 ;can0 bus timing register 0
0143                    CAN0BTR1:        equ REGBASE+$143 ;can0 bus timing register 1
0144                    CAN0RFLG:        equ REGBASE+$144 ;can0 receiver flags
0145                    CAN0RIER:        equ REGBASE+$145 ;can0 receiver interrupt enables
0146                    CAN0TFLG:        equ REGBASE+$146 ;can0 transmit flags
0147                    CAN0TIER:        equ REGBASE+$147 ;can0 transmit interrupt enables
0148                    CAN0TARQ:        equ REGBASE+$148 ;can0 transmit message abort control
0149                    CAN0TAAK:        equ REGBASE+$149 ;can0 transmit message abort status
014a                    CAN0TBEL:        equ REGBASE+$14a ;can0 transmit buffer select
014b                    CAN0IDAC:        equ REGBASE+$14b ;can0 identfier acceptance control
                        
014e                    CAN0RERR:        equ REGBASE+$14e ;can0 receive error counter
014f                    CAN0TERR:        equ REGBASE+$14f ;can0 transmit error counter
0150                    CAN0IDA0:        equ REGBASE+$150 ;can0 identifier acceptance register 0
0151                    CAN0IDA1:        equ REGBASE+$151 ;can0 identifier acceptance register 1
0152                    CAN0IDA2:        equ REGBASE+$152 ;can0 identifier acceptance register 2
0153                    CAN0IDA3:        equ REGBASE+$153 ;can0 identifier acceptance register 3
0154                    CAN0IDM0:        equ REGBASE+$154 ;can0 identifier mask register 0
0155                    CAN0IDM1:        equ REGBASE+$155 ;can0 identifier mask register 1
0156                    CAN0IDM2:        equ REGBASE+$156 ;can0 identifier mask register 2
0157                    CAN0IDM3:        equ REGBASE+$157 ;can0 identifier mask register 3
0158                    CAN0IDA4:        equ REGBASE+$158 ;can0 identifier acceptance register 4
0159                    CAN0IDA5:        equ REGBASE+$159 ;can0 identifier acceptance register 5
015a                    CAN0IDA6:        equ REGBASE+$15a ;can0 identifier acceptance register 6
015b                    CAN0IDA7:        equ REGBASE+$15b ;can0 identifier acceptance register 7
015c                    CAN0IDM4:        equ REGBASE+$15c ;can0 identifier mask register 4
015d                    CAN0IDM5:        equ REGBASE+$15d ;can0 identifier mask register 5
015e                    CAN0IDM6:        equ REGBASE+$15e ;can0 identifier mask register 6
015f                    CAN0IDM7:        equ REGBASE+$15f ;can0 identifier mask register 7
0160                    CAN0RXFG:        equ REGBASE+$160 ;can0 rx foreground buffer thru +$16f
0170                    CAN0TXFG:        equ REGBASE+$170 ;can0 tx foreground buffer thru +$17f
                        
0180                    CAN1CTL0:        equ REGBASE+$180 ;can1 control register 0
0181                    CAN1CTL1:        equ REGBASE+$181 ;can1 control register 1
0182                    CAN1BTR0:        equ REGBASE+$182 ;can1 bus timing register 0
0183                    CAN1BTR1:        equ REGBASE+$183 ;can1 bus timing register 1
0184                    CAN1RFLG:        equ REGBASE+$184 ;can1 receiver flags
0185                    CAN1RIER:        equ REGBASE+$185 ;can1 receiver interrupt enables
0186                    CAN1TFLG:        equ REGBASE+$186 ;can1 transmit flags
0187                    CAN1TIER:        equ REGBASE+$187 ;can1 transmit interrupt enables
0188                    CAN1TARQ:        equ REGBASE+$188 ;can1 transmit message abort control
0189                    CAN1TAAK:        equ REGBASE+$189 ;can1 transmit message abort status
018a                    CAN1TBEL:        equ REGBASE+$18a ;can1 transmit buffer select
018b                    CAN1IDAC:        equ REGBASE+$18b ;can1 identfier acceptance control
                        
018e                    CAN1RERR:        equ REGBASE+$18e ;can1 receive error counter
018f                    CAN1TERR:        equ REGBASE+$18f ;can1 transmit error counter
0190                    CAN1IDA0:        equ REGBASE+$190 ;can1 identifier acceptance register 0
0191                    CAN1IDA1:        equ REGBASE+$191 ;can1 identifier acceptance register 1
0192                    CAN1IDA2:        equ REGBASE+$192 ;can1 identifier acceptance register 2
0193                    CAN1IDA3:        equ REGBASE+$193 ;can1 identifier acceptance register 3
0194                    CAN1IDM0:        equ REGBASE+$194 ;can1 identifier mask register 0
0195                    CAN1IDM1:        equ REGBASE+$195 ;can1 identifier mask register 1
0196                    CAN1IDM2:        equ REGBASE+$196 ;can1 identifier mask register 2
0197                    CAN1IDM3:        equ REGBASE+$197 ;can1 identifier mask register 3
0198                    CAN1IDA4:        equ REGBASE+$198 ;can1 identifier acceptance register 4
0199                    CAN1IDA5:        equ REGBASE+$199 ;can1 identifier acceptance register 5
019a                    CAN1IDA6:        equ REGBASE+$19a ;can1 identifier acceptance register 6
019b                    CAN1IDA7:        equ REGBASE+$19b ;can1 identifier acceptance register 7
019c                    CAN1IDM4:        equ REGBASE+$19c ;can1 identifier mask register 4
019d                    CAN1IDM5:        equ REGBASE+$19d ;can1 identifier mask register 5
019e                    CAN1IDM6:        equ REGBASE+$19e ;can1 identifier mask register 6
019f                    CAN1IDM7:        equ REGBASE+$19f ;can1 identifier mask register 7
01a0                    CAN1RXFG:        equ REGBASE+$1a0 ;can1 rx foreground buffer thru +$1af
01b0                    CAN1TXFG:        equ REGBASE+$1b0 ;can1 tx foreground buffer thru +$1bf
                        
01c0                    CAN2CTL0:        equ REGBASE+$1c0 ;can2 control register 0
01c1                    CAN2CTL1:        equ REGBASE+$1c1 ;can2 control register 1
01c2                    CAN2BTR0:        equ REGBASE+$1c2 ;can2 bus timing register 0
01c3                    CAN2BTR1:        equ REGBASE+$1c3 ;can2 bus timing register 1
01c4                    CAN2RFLG:        equ REGBASE+$1c4 ;can2 receiver flags
01c5                    CAN2RIER:        equ REGBASE+$1c5 ;can2 receiver interrupt enables
01c6                    CAN2TFLG:        equ REGBASE+$1c6 ;can2 transmit flags
01c7                    CAN2TIER:        equ REGBASE+$1c7 ;can2 transmit interrupt enables
01c8                    CAN2TARQ:        equ REGBASE+$1c8 ;can2 transmit message abort control
01c9                    CAN2TAAK:        equ REGBASE+$1c9 ;can2 transmit message abort status
01ca                    CAN2TBEL:        equ REGBASE+$1ca ;can2 transmit buffer select
01cb                    CAN2IDAC:        equ REGBASE+$1cb ;can2 identfier acceptance control
                        
01ce                    CAN2RERR:        equ REGBASE+$1ce ;can2 receive error counter
01cf                    CAN2TERR:        equ REGBASE+$1cf ;can2 transmit error counter
01d0                    CAN2IDA0:        equ REGBASE+$1d0 ;can2 identifier acceptance register 0
01d1                    CAN2IDA1:        equ REGBASE+$1d1 ;can2 identifier acceptance register 1
01d2                    CAN2IDA2:        equ REGBASE+$1d2 ;can2 identifier acceptance register 2
01d3                    CAN2IDA3:        equ REGBASE+$1d3 ;can2 identifier acceptance register 3
01d4                    CAN2IDM0:        equ REGBASE+$1d4 ;can2 identifier mask register 0
01d5                    CAN2IDM1:        equ REGBASE+$1d5 ;can2 identifier mask register 1
01d6                    CAN2IDM2:        equ REGBASE+$1d6 ;can2 identifier mask register 2
01d7                    CAN2IDM3:        equ REGBASE+$1d7 ;can2 identifier mask register 3
01d8                    CAN2IDA4:        equ REGBASE+$1d8 ;can2 identifier acceptance register 4
01d9                    CAN2IDA5:        equ REGBASE+$1d9 ;can2 identifier acceptance register 5
01da                    CAN2IDA6:        equ REGBASE+$1da ;can2 identifier acceptance register 6
01db                    CAN2IDA7:        equ REGBASE+$1db ;can2 identifier acceptance register 7
01dc                    CAN2IDM4:        equ REGBASE+$1dc ;can2 identifier mask register 4
01dd                    CAN2IDM5:        equ REGBASE+$1dd ;can2 identifier mask register 5
01de                    CAN2IDM6:        equ REGBASE+$1de ;can2 identifier mask register 6
01df                    CAN2IDM7:        equ REGBASE+$1df ;can2 identifier mask register 7
01e0                    CAN2RXFG:        equ REGBASE+$1e0 ;can2 rx foreground buffer thru +$1ef
01f0                    CAN2TXFG:        equ REGBASE+$1f0 ;can2 tx foreground buffer thru +$1ff
                        
0200                    CAN3CTL0:        equ REGBASE+$200 ;can3 control register 0
0201                    CAN3CTL1:        equ REGBASE+$201 ;can3 control register 1
0202                    CAN3BTR0:        equ REGBASE+$202 ;can3 bus timing register 0
0203                    CAN3BTR1:        equ REGBASE+$203 ;can3 bus timing register 1
0204                    CAN3RFLG:        equ REGBASE+$204 ;can3 receiver flags
0205                    CAN3RIER:        equ REGBASE+$205 ;can3 receiver interrupt enables
0206                    CAN3TFLG:        equ REGBASE+$206 ;can3 transmit flags
0207                    CAN3TIER:        equ REGBASE+$207 ;can3 transmit interrupt enables
0208                    CAN3TARQ:        equ REGBASE+$208 ;can3 transmit message abort control
0209                    CAN3TAAK:        equ REGBASE+$209 ;can3 transmit message abort status
020a                    CAN3TBEL:        equ REGBASE+$20a ;can3 transmit buffer select
020b                    CAN3IDAC:        equ REGBASE+$20b ;can3 identfier acceptance control
                        
020e                    CAN3RERR:        equ REGBASE+$20e ;can3 receive error counter
020f                    CAN3TERR:        equ REGBASE+$20f ;can3 transmit error counter
0210                    CAN3IDA0:        equ REGBASE+$210 ;can3 identifier acceptance register 0
0211                    CAN3IDA1:        equ REGBASE+$211 ;can3 identifier acceptance register 1
0212                    CAN3IDA2:        equ REGBASE+$212 ;can3 identifier acceptance register 2
0213                    CAN3IDA3:        equ REGBASE+$213 ;can3 identifier acceptance register 3
0214                    CAN3IDM0:        equ REGBASE+$214 ;can3 identifier mask register 0
0215                    CAN3IDM1:        equ REGBASE+$215 ;can3 identifier mask register 1
0216                    CAN3IDM2:        equ REGBASE+$216 ;can3 identifier mask register 2
0217                    CAN3IDM3:        equ REGBASE+$217 ;can3 identifier mask register 3
0218                    CAN3IDA4:        equ REGBASE+$218 ;can3 identifier acceptance register 4
0219                    CAN3IDA5:        equ REGBASE+$219 ;can3 identifier acceptance register 5
021a                    CAN3IDA6:        equ REGBASE+$21a ;can3 identifier acceptance register 6
021b                    CAN3IDA7:        equ REGBASE+$21b ;can3 identifier acceptance register 7
021c                    CAN3IDM4:        equ REGBASE+$21c ;can3 identifier mask register 4
021d                    CAN3IDM5:        equ REGBASE+$21d ;can3 identifier mask register 5
021e                    CAN3IDM6:        equ REGBASE+$21e ;can3 identifier mask register 6
021f                    CAN3IDM7:        equ REGBASE+$21f ;can3 identifier mask register 7
0220                    CAN3RXFG:        equ REGBASE+$220 ;can3 rx foreground buffer thru +$22f
0230                    CAN3TXFG:        equ REGBASE+$230 ;can3 tx foreground buffer thru +$23f
                        
0240                    PTT:                equ REGBASE+$240 ;portt data register
0241                    PTIT:                equ REGBASE+$241 ;portt input register
0242                    DDRT:                equ REGBASE+$242 ;portt direction register
0243                    RDRT:                equ REGBASE+$243 ;portt reduced drive register
0244                    PERT:                equ REGBASE+$244 ;portt pull device enable
0245                    PPST:                equ REGBASE+$245 ;portt pull polarity select
                        
0248                    PTS:                equ REGBASE+$248 ;ports data register
0249                    PTIS:                equ REGBASE+$249 ;ports input register
024a                    DDRS:                equ REGBASE+$24a ;ports direction register
024b                    RDRS:                equ REGBASE+$24b ;ports reduced drive register
024c                    PERS:                equ REGBASE+$24c ;ports pull device enable
024d                    PPSS:                equ REGBASE+$24d ;ports pull polarity select
024e                    WOMS:                equ REGBASE+$24e ;ports wired or mode register
                        
0250                    PTM:                equ REGBASE+$250 ;portm data register
0251                    PTIM:                equ REGBASE+$251 ;portm input register
0252                    DDRM:                equ REGBASE+$252 ;portm direction register
0253                    RDRM:                equ REGBASE+$253 ;portm reduced drive register
0254                    PERM:                equ REGBASE+$254 ;portm pull device enable
0255                    PPSM:                equ REGBASE+$255 ;portm pull polarity select
0256                    WOMM:                equ REGBASE+$256 ;portm wired or mode register
0257                    MODRR:                equ REGBASE+$257 ;portm module routing register
                        
0258                    PTP:                equ REGBASE+$258 ;portp data register
0259                    PTIP:                equ REGBASE+$259 ;portp input register
025a                    DDRP:                equ REGBASE+$25a ;portp direction register
025b                    RDRP:                equ REGBASE+$25b ;portp reduced drive register
025c                    PERP:                equ REGBASE+$25c ;portp pull device enable
025d                    PPSP:                equ REGBASE+$25d ;portp pull polarity select
025e                    PIEP:                equ REGBASE+$25e ;portp interrupt enable register
025f                    PIFP:                equ REGBASE+$25f ;portp interrupt flag register
                        
0260                    PTH:                equ REGBASE+$260 ;porth data register
0261                    PTIH:                equ REGBASE+$261 ;porth input register
0262                    DDRH:                equ REGBASE+$262 ;porth direction register
0263                    RDRH:                equ REGBASE+$263 ;porth reduced drive register
0264                    PERH:                equ REGBASE+$264 ;porth pull device enable
0265                    PPSH:                equ REGBASE+$265 ;porth pull polarity select
0266                    PIEH:                equ REGBASE+$266 ;porth interrupt enable register
0267                    PIFH:                equ REGBASE+$267 ;porth interrupt flag register
                        
0268                    PTJ:                equ REGBASE+$268 ;portj data register
0269                    PTIJ:                equ REGBASE+$269 ;portj input register
026a                    DDRJ:                equ REGBASE+$26a ;portj direction register
026b                    RDRJ:                equ REGBASE+$26b ;portj reduced drive register
026c                    PERJ:                equ REGBASE+$26c ;portj pull device enable
026d                    PPSJ:                equ REGBASE+$26d ;portj pull polarity select
026e                    PIEJ:                equ REGBASE+$26e ;portj interrupt enable register
026f                    PIFJ:                equ REGBASE+$26f ;portj interrupt flag register
                        
0280                    CAN4CTL0:        equ REGBASE+$280 ;can4 control register 0
0281                    CAN4CTL1:        equ REGBASE+$281 ;can4 control register 1
0282                    CAN4BTR0:        equ REGBASE+$282 ;can4 bus timing register 0
0283                    CAN4BTR1:        equ REGBASE+$283 ;can4 bus timing register 1
0284                    CAN4RFLG:        equ REGBASE+$284 ;can4 receiver flags
0285                    CAN4RIER:        equ REGBASE+$285 ;can4 receiver interrupt enables
0286                    CAN4TFLG:        equ REGBASE+$286 ;can4 transmit flags
0287                    CAN4TIER:        equ REGBASE+$287 ;can4 transmit interrupt enables
0288                    CAN4TARQ:        equ REGBASE+$288 ;can4 transmit message abort control
0289                    CAN4TAAK:        equ REGBASE+$289 ;can4 transmit message abort status
028a                    CAN4TBEL:        equ REGBASE+$28a ;can4 transmit buffer select
028b                    CAN4IDAC:        equ REGBASE+$28b ;can4 identfier acceptance control
                        
028e                    CAN4RERR:        equ REGBASE+$28e ;can4 receive error counter
028f                    CAN4TERR:        equ REGBASE+$28f ;can4 transmit error counter
0290                    CAN4IDA0:        equ REGBASE+$290 ;can4 identifier acceptance register 0
0291                    CAN4IDA1:        equ REGBASE+$291 ;can4 identifier acceptance register 1
0292                    CAN4IDA2:        equ REGBASE+$292 ;can4 identifier acceptance register 2
0293                    CAN4IDA3:        equ REGBASE+$293 ;can4 identifier acceptance register 3
0294                    CAN4IDM0:        equ REGBASE+$294 ;can4 identifier mask register 0
0295                    CAN4IDM1:        equ REGBASE+$295 ;can4 identifier mask register 1
0296                    CAN4IDM2:        equ REGBASE+$296 ;can4 identifier mask register 2
0297                    CAN4IDM3:        equ REGBASE+$297 ;can4 identifier mask register 3
0298                    CAN4IDA4:        equ REGBASE+$298 ;can4 identifier acceptance register 4
0299                    CAN4IDA5:        equ REGBASE+$299 ;can4 identifier acceptance register 5
029a                    CAN4IDA6:        equ REGBASE+$29a ;can4 identifier acceptance register 6
029b                    CAN4IDA7:        equ REGBASE+$29b ;can4 identifier acceptance register 7
029c                    CAN4IDM4:        equ REGBASE+$29c ;can4 identifier mask register 4
029d                    CAN4IDM5:        equ REGBASE+$29d ;can4 identifier mask register 5
029e                    CAN4IDM6:        equ REGBASE+$29e ;can4 identifier mask register 6
029f                    CAN4IDM7:        equ REGBASE+$29f ;can4 identifier mask register 7
02a0                    CAN4RXFG:        equ REGBASE+$2a0 ;can4 rx foreground buffer thru +$2af
02b0                    CAN4TXFG:        equ REGBASE+$2b0 ;can4 tx foreground buffer thru +$2bf
                        
                        * end registers
                        #endinclude

                        
                        ;*******************************************************************************
                        ;       UNIVERSIDAD DE COSTA RICA       ESCUELA DE INGENIERIA ELECTRICA
                        ;               MICROPROCESADORES IE 623  III CICLO 2020
                        ;*******************************************************************************
                        ;                                 TAREA 5
                        ;*******************************************************************************
                        ;       V1
                        ;       AUTORES: ROBIN GONZALEZ   B43011
                        ;                MICHELLE GUTIERREZ     B43195
                        ;
                        ;       DESCRIPCION:    Contador de tornillos
                        ;
                        ;*******************************************************************************
                        ;                             Estructuras de datos
                        ;*******************************************************************************
                        
00ff                    EOM:     EQU     $FF
00ff                    VMAX:    EQU     $FF
                        
1000                                    ORG $1000
1000                    Banderas:        ds      1 ;x:x:x:CambMod:ModActual:ARRAY_OK:TCL_LEIDA:TCL_LISTA
1001 02                 MAX_TCL:         db      2      ;segun enunciado
1002                    Tecla:           ds      1
1003                    Tecla_IN:        ds      1
1004                    Cont_Reb:        ds      1
1005                    Cont_TCL:        ds      1
1006                    Patron:          ds      1
1007                    Num_Array:       ds      2
1009                    CUENTA:          ds      1
100a                    AcmPQ:           ds      1
100b                    CantPQ:          ds      1
100c                    TIMER_CUENTA:    ds      1
100d                    LEDS:            ds      1
100e                    BRILLO:          ds      1
100f                    CONT_DIG:        ds      1
1010                    CONT_TICKS:      ds      1
1011                    DT:              ds      1
1012                    BIN1:            ds      1
1013                    BIN2:            ds      1
1014                    BCD_L:           ds      1
1015                    LOW:             ds      1
1016                    TEMP:            ds      1
1017                    BCD1:            ds      1
1018                    BCD2:            ds      1
1019                    DISP1:           ds      1
101a                    DISP2:           ds      1
101b                    DISP3:           ds      1
101c                    DISP4:           ds      1
101d 00 01              CONT_7SEG:       dw      1
101f                    Cont_Delay:      ds      1
1020 64                 D2mS:            db      100
1021 0d                 D260uS:          db      13
1022 02                 D40uS:           db      2
1023 01                 Clear_LCD:       db      $01 ;comando borrar pantalla
1024 80                 ADD_L1:          db      $80 ;dir de inicio de linea 1 en DDRAM de pantalla
1025 c0                 ADD_L2:          db      $C0 ;dir de inicio de linea 2 en DDRAM de pantalla
1026 01 02 03 04 05 06  Teclas:          db      $01,$02,$03,$04,$05,$06,$07,$08,$09,$0B,$0,$0E,0,0,0,0
     07 08 09 0b 00 0e
     00 00 00 00
1036                    SEGMENT:         ds      16
1046 28 28 06 0f        iniDsp:          db      $28,$28,$06,$0F
1060                                    org $1060
1060 20 20 4d 4f 44 4f  Msg1_L1:                 fcc     "  MODO CONFIG"
     20 43 4f 4e 46 49
     47
106d ff                                 db EOM
106e 49 6e 67 72 65 73  Msg1_L2:                 fcc     "Ingrese CantPQ"
     65 20 43 61 6e 74
     50 51
107c ff                                 db EOM
107d 20 20 20 20 4d 4f  Msg2_L1:                 fcc     "    MODO RUN"
     44 4f 20 52 55 4e
1089 ff                                 db EOM
108a 20 20 41 63 6d 50  Msg2_L2:                 fcc     "  AcmPQ  CUENTA"
     51 20 20 43 55 45
     4e 54 41
1099 ff                                 db EOM
                        
                        
                        ;*******************************************************************************
                        ;                             Relocalizar vectores
                        ;*******************************************************************************
                        
3e4c                             org        $3E4C       ;debug12
3e4c 23 ac                      dw PTH_ISR
                        
3e70                             org        $3E70       ;debug12
3e70 23 a0                      dw RTI_ISR
                        
3e66                             org        $3E66       ;debug12
3e66 24 36                      dw OC4_ISR
                        
                        ;*******************************************************************************
                        ;          Inicializacion de estructuras de datos y config de hardware
                        ;*******************************************************************************
                        
2000                                    ORG     $2000
                        
2000 18 0b 00 10 00             MOVB #0,Banderas
2005 18 0b ff 10 02             MOVB #$FF,Tecla
200a 18 0b ff 10 03             MOVB #$FF,Tecla_IN
200f 18 0b 00 10 04             MOVB #0,Cont_Reb
2014 18 0b 00 10 05             MOVB #0,Cont_TCL
2019 18 0b 00 10 06             MOVB #0,Patron
201e 18 0b ff 10 07             MOVB #$FF,Num_Array
2023 18 0b ff 10 08             MOVB #$FF,Num_Array+1
2028 18 0b ff 10 09             MOVB #$FF,Num_Array+2
202d 18 0b ff 10 0a             MOVB #$FF,Num_Array+3
2032 18 0b ff 10 0b             MOVB #$FF,Num_Array+4
2037 18 0b ff 10 0c             MOVB #$FF,Num_Array+5
203c 18 0b 63 10 09             MOVB #99,CUENTA
2041 18 0b 63 10 0a             MOVB #99,AcmPQ
2046 18 0b 01 10 0b             MOVB #1,CantPQ
204b 18 0b 00 10 0d             MOVB #0,LEDS
2050 18 0b 32 10 0e             MOVB #50,BRILLO
2055 18 0b 01 10 0f             MOVB #1,CONT_DIG        ;para que funcione bien OC4
205a 18 0b 00 10 11             MOVB #0,DT
205f 18 0b 00 10 12             MOVB #0,BIN1
2064 18 0b 00 10 13             MOVB #0,BIN2
2069 18 0b 00 10 14             MOVB #0,BCD_L
206e 18 0b 00 10 15             MOVB #0,LOW
2073 18 0b 00 10 16             MOVB #0,TEMP
2078 18 0b 00 10 17             MOVB #0,BCD1
207d 18 0b 00 10 18             MOVB #0,BCD2
2082 18 0b 00 10 19             MOVB #0,DISP1
2087 18 0b 00 10 1a             MOVB #0,DISP2
208c 18 0b 00 10 1b             MOVB #0,DISP3
2091 18 0b 00 10 1c             MOVB #0,DISP4
2096 18 0b 00 10 1d             MOVB #0,CONT_7SEG
209b 18 0b 32 10 1d             MOVB #50,CONT_7SEG + 1
20a0 18 0b 00 10 1f             MOVB #0,Cont_Delay
20a5 18 0b ff 10 0c             MOVB #VMAX,TIMER_CUENTA
                        
                                ;Inicializacion de hardware
                        
                                ;Rele:
20aa 4c 09 04                   BSET DDRE,$04   ;activar pin 2 de puerto E Rele como salida
                        
                                ;Pantalla LCD
20ad 4c 33 ff                   BSET DDRK,$FF  ;nibble inferior como salida
20b0 4d 32 01                   BClR PORTK,$01
                        
                                ;Pantalla 7 segmentos
20b3 1c 02 5a 0f                BSET DDRP,$0F  ;poner pads de salida,apagar 7 segmentos
                        
                                ;LEDS
20b7 18 0b ff 00 03             MOVB #$FF,DDRB
20bc 1c 02 6a 02                BSET DDRJ,$02   ;bit 2 como salida
20c0 1d 02 68 02                BCLR PTJ,$02    ;bit 2 en 0, catodo comun
                        
                                ;Teclado matricial
20c4 18 0b f0 00 02             MOVB #$F0,DDRA
20c9 4c 0c 01                   BSET PUCR,$01
                        
                                ;RTI
20cc 4c 38 80                   BSET CRGINT,$80
20cf 18 0b 17 00 3b             MOVB #$17,RTICTL
                        
                                ;PTH
20d4 79 02 62                   CLR DDRH
20d7 1c 02 66 0f                BSET PIEH,$0F
20db 1d 02 65 0f                BCLR PPSH,$0F   ;interrupcion en flanco decreciente
                        
                                ;OC4
20df 4c 46 90                   BSET TSCR1,$90  ;encendemos Timer, TFFCLA
20e2 4c 4d 04                   BSET TSCR2,$04  ;poner prescalador en 16
20e5 4c 40 10                   BSET TIOS,$10
20e8 4c 4c 10                   BSET TIE,$10  ;habilitar interrupcion por canal 4
20eb cc 00 1e                   LDD #30
20ee d3 44                      ADDD TCNT
20f0 5c 58                      STD TC4
                        
                        
                        
                        
20f2 cf 3b ff                   LDS #$3BFF
20f5 10 ef                      CLI
                        
20f7 16 21 78                   JSR LCD_INIT
                         ;        LDX #Msg1_L1
                         ;        LDY #Msg1_L2
                         ;        JSR Cargar_LCD
                        
                        
                        ;*******************************************************************************
                        ;                             PROGRAMA PRINCIPAL
                        ;*******************************************************************************
                        
20fa                    main:
                        
                                ;BRSET Banderas,$04,main ;salta a main si el bits 2 (%0000 0100) es 1 en Banderas
                                ;JSR Tarea_Teclado       ;ir a subrutina Tarea_Teclado
20fa 1c 10 00 10                BSET Banderas,$10 ; Bandera 4 (CambMod en 1)
20fe                    Loop_main:
20fe f7 10 0b                   TST CantPQ
2101 27 4e                      Beq Antes_Rama_CONFIG
2103 86 80                      Ldaa #$80
2105 b4 02 60                   Anda PTH
2108 c6 08                      Ldab #08
210a f4 10 00                   Andb Banderas
210d 44                         LSRA    ;corre a derecha un bit sin meter carry
210e 44                         LSRA
210f 44                         LSRA
2110 44                         LSRA
2111 7a 10 16                   Staa TEMP
2114 18 17                      CBA ; ModSel = ModActual
2116 27 0d                      Beq Revisar_ModSel
2118 1c 10 00 10                BSET Banderas,$10    ; Banderas.4 (Camb_Mod) en 1
211c 1f 10 16 08 2a             BRCLR TEMP,$08,quitar_modo_actual
2121 1c 10 00 08                BSET Banderas,$08
2125                    Revisar_ModSel:
2125 1e 10 16 08 2b             BRSET TEMP,$08,Rama_CONFIG
212a 1f 10 00 10 12             BRCLR Banderas,$10,Ir_a_Modo_RUN
212f 1d 10 00 10                BCLR Banderas,$10
2133 18 0b 08 00 01             MOVB #$08,PORTB ;led 3
                                ;Ldaa Clear_LCD
                                ;Jsr SendCommand
                                ;MOVB D2mS,Cont_Delay
                                ;Jsr Delay
                                ;JSR LCD_INIT
2138 ce 10 7d                   Ldx #Msg2_L1
213b cd 10 8a                   Ldy #Msg2_L2
213e 16 22 10                   Jsr Cargar_LCD
2141                    Ir_a_Modo_RUN:
2141 18 0b 04 00 01             MOVB #$04,PORTB   ;led 2
2146 16 21 d6                   Jsr MODO_RUN
2149 20 b3                      Bra Loop_main
214b                    quitar_modo_actual:
214b 1d 10 00 08                BCLR Banderas,$08
214f 20 d4                      Bra Revisar_ModSel
2151                    Antes_Rama_CONFIG:
2151 1c 10 00 08                BSET Banderas,$08
2155                    Rama_CONFIG:
2155 1f 10 00 10 12             BRCLR Banderas,$10,Ir_a_Modo_CONFIG
215a 1d 10 00 10                BCLR Banderas,$10
215e 18 0b 80 00 01             MOVB #$80,PORTB ;led 7
                                ;Ldaa Clear_LCD
                                ;Jsr SendCommand
                                ;MOVB D2mS,Cont_Delay
                                ;Jsr Delay
                                ;JSR LCD_INIT
2163 ce 10 60                   Ldx #Msg1_L1
2166 cd 10 6e                   Ldy #Msg1_L2
2169 16 22 10                   Jsr Cargar_LCD
216c                    Ir_a_Modo_CONFIG:
216c 18 0b 40 00 01             MOVB #$40,PORTB ;led 6
2171 16 21 9f                   Jsr MODO_CONFIG
2174 18 20 ff 86                LBra Loop_main
                                ; Cambiar CamMod se usa $10
                                ; Cambiar ModActual se usa $08
                        
                               ;BRA *
                        
                        ;*******************************************************************************
                        ;                                     SUBRUTINAS
                        ;*******************************************************************************
                        
2178                    LCD_INIT:
                                ;configuracion inical de la LCD
2178 c7                         CLRB
2179 ce 10 46                   LDX #iniDsp
217c                    loopIniDsp:
217c a6 e5                      LDAA B,X
217e 16 22 66                   JSR SendCommand
2181 18 0c 10 22 10 1f          MOVB D40uS,Cont_Delay
2187 16 22 cc                   JSR Delay
218a 52                         INCB
218b c1 04                      CMPB #4
218d 26 ed                      BNE loopIniDsp
218f b6 10 23                   LDAA Clear_LCD
2192 16 22 66                   JSR SendCommand
2195 18 0c 10 20 10 1f          MOVB D2mS,Cont_Delay
219b 16 22 cc                   JSR Delay
219e 3d                         RTS
                        
219f                    MODO_CONFIG:
219f 18 0b 02 10 0d           MOVB #2,LEDS
                              ;INC CantPQ
21a4 18 0b 02 10 0d           MOVB #2,LEDS
21a9 1f 10 00 04 24           BrClr Banderas,$04,llamar_Tarea_Teclado   ; Se moidifica Array_Ok con mscara $04
21ae 16 22 d2                 Jsr BCD_BIN
21b1 86 19                    Ldaa #25
21b3 b1 10 0b                 Cmpa CantPQ
21b6 25 07                    Blo no_valido
21b8 86 55                    Ldaa #85
21ba b1 10 0b                 Cmpa CantPQ
21bd 25 08                    Blo valido
21bf                    no_valido:
21bf 1d 10 00 04              BClr Banderas,$04
21c3 79 10 0b                 Clr CantPQ
21c6 3d                       Rts
21c7                    valido:
21c7 1d 10 00 04              BClr Banderas,$04
21cb 18 0c 10 0b 10 12        Movb CantPQ,BIN1
21d1 3d                       Rts
21d2                    llamar_Tarea_Teclado:
21d2 16 25 07                 Jsr Tarea_Teclado
21d5 3d                       Rts
                        
                        
21d6                    MODO_RUN:               ;                 Subrutina MODO_RUN
                                                ;*******************************************************
                                                ; Subrutina que lleva la cuenta de tornillos
                                                ;*******************************************************
21d6 18 0b 01 10 0d             MOVB #1,LEDS
21db f7 10 0c                   TST TIMER_CUENTA
21de 26 23                      BNE retorno_MODO_RUN
21e0 18 0b ff 10 0c             MOVB #VMAX,TIMER_CUENTA
21e5 72 10 09                   INC CUENTA
21e8 b6 10 09                   LDAA CUENTA
21eb b1 10 0b                   CMPA CantPQ
21ee 26 13                      BNE retorno_MODO_RUN
21f0 4d 38 80                   BCLR CRGINT,$80 ;apagar RTI
21f3 72 10 0a                   INC AcmPQ
21f6 4c 08 04                   BSET PORTE,$04
21f9 86 64                      LDAA #100
21fb b1 10 0a                   CMPA AcmPQ
21fe 26 03                      BNE retorno_MODO_RUN
2200 79 10 0a                   CLR AcmPQ
                        
2203                    retorno_MODO_RUN:
2203 18 0c 10 09 10 12          MOVB CUENTA,BIN1
2209 18 0c 10 0a 10 13          MOVB AcmPQ,BIN2
220f 3d                         RTS
                        
                        
                        
                        
2210                    Cargar_LCD:             ;                 Subrutina Cargar_LCD
                                                ;*******************************************************
                                                ;Envia datos a al pantalla LCD
                                                ;recibe direcciones de datos en X linea 1 y en Y linea 2
                                                ;llama a SendCommand y SendData
                                                ;*******************************************************
2210 b6 10 23                   LDAA Clear_LCD  ;para borrar info anterior en pantalla LCD
2213 16 22 66                   JSR SendCommand
2216 18 0c 10 20 10 1f          MOVB D2mS,Cont_Delay
221c 16 22 cc                   JSR Delay
                        
221f b6 10 24                   LDAA ADD_L1
2222 16 22 66                   JSR SendCommand
2225 18 0c 10 22 10 1f          MOVB D40uS,Cont_Delay
222b 16 22 cc                   JSR Delay
222e                    loop_L1:
222e a6 30                      LDAA 1,X+
2230 81 ff                      CMPA #EOM          ; NUMERAL NUMERAL NUMERAL -> Hay que poner numeral si uso un valor definido con EQU
2232 27 0e                      BEQ inicio_L2
2234 16 22 99                   JSR SendData
2237 18 0c 10 22 10 1f          MOVB D40uS,Cont_Delay
223d 16 22 cc                   JSR Delay
2240 20 ec                      BRA loop_L1
                        
2242                    inicio_L2:
2242 b6 10 25                   LDAA ADD_L2
2245 16 22 66                   JSR SendCommand
2248 18 0c 10 22 10 1f          MOVB D40uS,Cont_Delay
224e 16 22 cc                   JSR Delay
2251                    loop_L2:
2251 a6 70                      LDAA 1,Y+
2253 81 ff                      CMPA #EOM          ; NUMERAL NUMERAL NUMERAL -> Hay que poner numeral si uso un valor definido con EQU
2255 27 0e                      BEQ retorno_cargar_LCD
2257 16 22 99                   JSR SendData
225a 18 0c 10 22 10 1f          MOVB D40uS,Cont_Delay
2260 16 22 cc                   JSR Delay
2263 20 ec                      BRA loop_L2
                        
2265                    retorno_cargar_LCD:
2265 3d                         RTS
                        
2266                    SendCommand:            ;                 Subrutina SendCommand
                                                ;*******************************************************
                                                ;Envia comandos a la memoria de la pantalla LCD
                                                ;recibe el comando en A
                                                ;*******************************************************
2266 36                         PSHA
2267 84 f0                      ANDA #$F0
2269 44                         LSRA
226a 44                         LSRA
226b 5a 32                      STAA PORTK
226d 4d 32 01                   BCLR PORTK,$01
2270 4c 32 02                   BSET PORTK,$02
2273 18 0c 10 21 10 1f          MOVB D260uS,Cont_Delay
2279 16 22 cc                   JSR Delay
227c 4d 32 02                   BCLR PORTK,$02
227f 32                         PULA
2280 84 0f                      ANDA #$0F
2282 48                         LSLA
2283 48                         LSLA
2284 5a 32                      STAA PORTK
2286 4d 32 01                   BCLR PORTK,$01
2289 4c 32 02                   BSET PORTK,$02
228c 18 0c 10 21 10 1f          MOVB D260uS,Cont_Delay
2292 16 22 cc                   JSR Delay
2295 4d 32 02                   BCLR PORTK,$02
2298 3d                         RTS
                        
                                                ;*******************************************************
2299                    SendData:               ;                 Subrutina SendData
                                                ;*******************************************************
                                                ;Envia datos a la memoria de la pantalla LCD, recibe
                                                ;comando en A
                                                ;*******************************************************
2299 36                         PSHA
229a 84 f0                      ANDA #$F0
229c 44                         LSRA
229d 44                         LSRA
229e 5a 32                      STAA PORTK
22a0 4c 32 01                   BSET PORTK,$01       ;dato
22a3 4c 32 02                   BSET PORTK,$02
22a6 18 0c 10 21 10 1f          MOVB D260uS,Cont_Delay
22ac 16 22 cc                   JSR Delay
22af 4d 32 02                   BCLR PORTK,$02
22b2 32                         PULA
22b3 84 0f                      ANDA #$0F
22b5 48                         LSLA
22b6 48                         LSLA
22b7 5a 32                      STAA PORTK
22b9 4c 32 01                   BSET PORTK,$01  ;dato
22bc 4c 32 02                   BSET PORTK,$02
22bf 18 0c 10 21 10 1f          MOVB D260uS,Cont_Delay
22c5 16 22 cc                   JSR Delay
22c8 4d 32 02                   BCLR PORTK,$02
22cb 3d                         RTS
                        
                                                ;*******************************************************
22cc                    Delay:                  ;                 Subrutina Delay
                                                ;*******************************************************
                                                ;Genera retardo para enviar informacin a la pantalla
                                                ;LCD, se queda en un loop hasta que la variable ha sido
                                                ;DECrementada a 0 por OC4
                                                ;*******************************************************
22cc f7 10 1f                   TST Cont_Delay
22cf 26 fb                      BNE Delay
22d1 3d                         RTS
                        
                        
22d2                    BCD_BIN:                 ;          Subrutina BCD_BIN
                                                 ;******************************************************
                                                 ;  Se encarga de convertir un nmero de BCD a Binario
                                                 ;******************************************************
22d2 ce 10 07                    Ldx #Num_Array
22d5 c6 0a                       Ldab #$A
22d7 a6 20                       Ldaa 1,+X
22d9 12                          Mul
22da a6 00                       Ldaa 0,X
22dc 18 06                       Aba
22de 7a 10 0b                    Staa CantPQ
22e1 3d                          Rts
                        
22e2                    BIN_BCD:                 ;          Subrutina BIN_BCD
                                                 ;**********************************************************
                                                 ;Subrutina que pasa un nmero de binario (BIN) a BCD (BCD_l)
                                                 ;**********************************************************
                                 ;Ldaa BIN1   ;  Tengo que meter el nmero binario en el acumulador A antes
22e2 c6 07                       Ldab #7
22e4 18 0b 00 10 14              Movb #0,BCD_L
22e9 48                 Loop1:   Lsla
22ea 75 10 14                    Rol BCD_L
22ed 7a 10 16                    Staa TEMP
22f0 86 0f                       Ldaa #$0F
22f2 b4 10 14                    Anda BCD_L
22f5 81 05                       Cmpa #5
22f7 25 02                       Blo no_mayor_a_5
22f9 8b 03                       Adda #3
22fb                    no_mayor_a_5:
22fb 7a 10 15                    Staa LOW
22fe 86 f0                       Ldaa #$F0
2300 b4 10 14                    Anda BCD_L
2303 81 32                       Cmpa #50
2305 25 02                       Blo no_mayor_a_50
2307 8b 1e                       Adda #30
2309                    no_mayor_a_50:
2309 bb 10 15                    Adda LOW
230c 7a 10 14                    Staa BCD_L
230f b6 10 16                    Ldaa TEMP
2312 53                          Decb
2313 d7                          Tstb
2314 26 d3                       Bne Loop1
2316 48                          Lsla
2317 75 10 14                    Rol BCD_L
231a 3d                          Rts
                        
231b                    BCD_7SEG:                ;          Subrutina BCD_7SEG
                                                 ;**********************************************************
                                                 ;  Carga los valores correspondientes a ser desplegados
                                                 ; en la pantalla de 7 segmentos
                                                 ;**********************************************************
231b ce 10 36                    Ldx #SEGMENT
231e 96 0f                       Ldaa $0F
2320 b4 10 18                    Anda BCD2
2323 18 0d e4 10 1a              Movb A,X,DISP2
2328 96 f0                       Ldaa $F0
232a b4 10 18                    Anda BCD2
232d 44                          Lsra
232e 44                          Lsra
232f 44                          Lsra
2330 44                          Lsra
2331 18 0d e4 10 19              Movb A,X,DISP1
2336 96 0f                       Ldaa $0F
2338 b4 10 17                    Anda BCD1
233b 18 0d e4 10 1b              Movb A,X,DISP3
2340 96 f0                       Ldaa $F0
2342 b4 10 17                    Anda BCD1
2345 44                          Lsra
2346 44                          Lsra
2347 44                          Lsra
2348 44                          Lsra
2349 18 0d e4 10 1c              Movb A,X,DISP4
234e 3d                          Rts
                        
                        
234f                    CONV_BIN_BCD:            ;          Subrutina CONV_BIN_BCD
                                                 ;******************************************************
                                                 ;  Se encarga de poner BIN1 y BIN2 en el acumulador dos
                                                 ;  para llamar a BIN_BCD y guardar los resultados
                                                 ; segn corresponda, adems devuelve $B si un LED
                                                 ; debe estar apagado
                                                 ;******************************************************
234f b6 10 12                    Ldaa BIN1
2352 16 22 e2                    Jsr BIN_BCD
2355 18 0c 10 14 10 17           Movb BCD_L,BCD1
235b b6 10 13                    Ldaa BIN2
235e 16 22 e2                    Jsr BIN_BCD
2361 18 0c 10 14 10 18           Movb BCD_L,BCD2
2367 f7 10 17                    Tst BCD1
236a 27 27                       Beq es_cero
236c b6 10 17                    Ldaa BCD1
236f 81 0a                       Cmpa #10
2371 25 0d                       Blo BCD1_es_menor_a_10
2373                    revisar_BCD2:
2373 f7 10 18                    Tst BCD2
2376 27 22                       Beq BCD2_es_cero
2378 b6 10 18                    Ldaa BCD2
237b 81 0a                       Cmpa #10
237d 25 0b                       Blo BCD2_es_menor_a_10
237f 3d                          Rts
2380                    BCD1_es_menor_a_10:
2380 86 b0                       Ldaa #$B0
2382 b8 10 17                    Eora BCD1
2385 7a 10 17                    Staa BCD1
2388 20 e9                       Bra revisar_BCD2
238a                    BCD2_es_menor_a_10:
238a 86 b0                       Ldaa #$B0
238c b8 10 18                    Eora BCD2
238f 7a 10 18                    Staa BCD2
2392 3d                          Rts
2393                    es_cero:
2393 18 0b bb 10 17              Movb #$BB,BCD1
2398 20 d9                       Bra revisar_BCD2
239a                    BCD2_es_cero:
239a 18 0b bb 10 18              Movb #$BB,BCD2
239f 3d                          Rts
                        
                        
                        
                        ;*******************************************************************************
                        ;                        SUBRUTINAS DE INTERRUPCION
                        ;*******************************************************************************
                        
23a0                    RTI_ISR:                ;                Subrutina RTI_ISR
                                                ;*******************************************************
                                                ;Subrutina que cuenta 1 ms
                                                ;*******************************************************
23a0 4c 37 80                   BSET CRGFLG,$80         ;borrar bandera de interrupcion
23a3 1f 10 04 ff 03             BRCLR Cont_Reb,$FF,retorno_RTI  ;salta si la pos Cont_reb es 0
23a8 73 10 04                   DEC Cont_Reb    ;decrementar Cont_Reb
                        
23ab                    retorno_RTI:
23ab 0b                         RTI
                        
                        
                        
                        
23ac                    PTH_ISR:                ;                Subrutina PTH_ISR
                                                ;*******************************************************
                                                ;Subrutina que lee botones conectados al puerto H
                                                ;*******************************************************
                        
23ac                    retorno_PTH:
23ac 1e 10 00 08 14             BRSET Banderas,$08,saltar_pth0  ;revisa Mod_Actual   config si es 1
23b1 1f 02 67 01 0f             BRCLR PIFH,$01,saltar_pth0
23b6 1c 02 67 01                BSET PIFH,$01
23ba 79 10 09                   CLR CUENTA
23bd 4d 08 04                   BCLR PORTE,$04  ;apagar Rel
23c0 4c 38 80                   BSET CRGINT,$80  ;encender RTI
23c3 20 2c                      BRA retorno_PTH_ISR
                        
23c5                    saltar_pth0:
23c5 f7 10 04                   TST Cont_Reb
23c8 26 27                      BNE retorno_PTH_ISR
23ca 1f 10 02 80 15             BRClr Tecla,$80,segundo_ingreso ; Si Tecla.7 = 1 es el primer ingreso
23cf 18 0c 02 67 10 02          MOVB PIFH,Tecla
23d5 86 0f                      LDAA #$0F
23d7 b4 02 67                   ANDA PIFH
23da 7a 02 67                   STAA PIFH
23dd 18 0b 05 10 04             MOVB #5,Cont_Reb
                                ;BCLR Tecla,$80  ;indicar que ya entro por primera vez
23e2 20 0d                      BRA retorno_PTH_ISR
                        
23e4                    segundo_ingreso:
23e4 f6 02 67                   LDAB PIFH
23e7 f1 10 02                   CMPB Tecla      ;revisar si valores anteriores de PIFH son iguales ahora
23ea 27 06                      BEQ lectura_correcta
23ec 18 0b ff 10 02             MOVB #$FF,Tecla
                        
23f1                    retorno_PTH_ISR:
23f1 0b                         RTI
                        
23f2                    lectura_correcta:
23f2 1c 10 02 80                BSET Tecla,$80
23f6 b6 10 0e                   LDAA BRILLO
23f9 1e 02 67 04 29             BRSET PIFH,$04,disminuir_brillo
23fe 1e 02 67 08 15             BRSET PIFH,$08,aumentar_brillo
2403 1e 10 00 08 e9             BRSET Banderas,$08,retorno_PTH_ISR      ;Mod_actual es 1 : config
2408 1e 02 67 02 02             BRSET PIFH,$02,AcmCLEAR
240d 20 e2                      BRA retorno_PTH_ISR
                        
240f                    AcmCLEAR:
240f 1c 02 67 02                BSET PIFH,$02
2413 79 10 0a                   CLR AcmPQ
2416 20 d9                      BRA retorno_PTH_ISR
                        
2418                    aumentar_brillo:
2418 1c 02 67 08                BSET PIFH,$08
241c 81 5f                      CMPA #95
241e 24 d1                      BHS retorno_PTH_ISR     ;salta si A mayor o igual a 95
2420 8b 05                      ADDA #5
2422 7a 10 0e                   STAA BRILLO
2425 20 ca                      BRA retorno_PTH_ISR
                        
2427                    disminuir_brillo:
2427 1c 02 67 04                BSET PIFH,$04
242b 81 05                      CMPA #5
242d 23 c2                      BLS retorno_PTH_ISR     ;salta si A es menor o igual a 5
242f 80 05                      SUBA #5
2431 7a 10 0e                   STAA BRILLO
2434 20 bb                      BRA retorno_PTH_ISR
                        
2436                    OC4_ISR:
                        ;        BSET TFLG2,$80  ;borrar int estamos usando TFFCA
                                                ;                Subrutina OC4_ISR
                                                ;*******************************************************
                                                ;Subrutina que genera interrupciones cada 50 KHz
                                                ;*******************************************************
2436 f7 10 1f                   Tst Cont_Delay
2439 27 03                      BEQ aumentar_CONT_TICKS
243b 73 10 1f                   Dec Cont_Delay
243e                    aumentar_CONT_TICKS:
243e 72 10 10                   Inc CONT_TICKS
2441 86 64                      Ldaa #100
2443 b1 10 10                   Cmpa CONT_TICKS
2446 26 12                      Bne aumentar_CONT_7SEG
2448 79 10 10                   Clr CONT_TICKS
244b 78 10 0f                   Lsl CONT_DIG
244e 86 10                      Ldaa #$10
2450 b1 10 0f                   Cmpa CONT_DIG
2453 26 05                      BNE aumentar_CONT_7SEG
2455 18 0b 01 10 0f             MOVB #1,CONT_DIG
245a                    aumentar_CONT_7SEG:    ;aumentar cont7_seg
245a fc 10 1d                   Ldd CONT_7SEG
245d c3 00 01                   Addd #1
2460 7c 10 1d                   Std CONT_7SEG
                        ;        Ldd #5000
2463 8c 13 88                   Cpd #5000
2466 26 0c                      BNE Antes_de_revisar_CONT_DIG
2468 18 03 00 00 10 1d          Movw #$0,CONT_7SEG ;Si uso move word se pone 0 cont7seg +1 ?
246e 16 23 4f                   Jsr CONV_BIN_BCD
2471 16 23 1b                   Jsr BCD_7SEG
                        
2474                    Antes_de_revisar_CONT_DIG:
2474 86 64                      Ldaa #100
2476 b0 10 0e                   Suba BRILLO
2479 18 0e                      Tab
247b 86 64                      Ldaa #100
247d 18 16                      Sba
247f 7a 10 11                   Staa DT
2482 b1 10 10                   Cmpa CONT_TICKS ; lo que est en a es DT (se acaba de guardar)
2485 24 79                      Bhs  Portb_cero
2487 86 01                      Ldaa #1
2489 b1 10 0f                   Cmpa CONT_DIG
248c 27 61                      Beq CONT_DIG_es_1
248e 86 02                      Ldaa #2
2490 b1 10 0f                   Cmpa CONT_DIG
2493 27 49                      Beq CONT_DIG_es_2
2495 86 04                      Ldaa #4
2497 b1 10 0f                   Cmpa CONT_DIG
249a 27 31                      Beq CONT_DIG_es_4
249c 86 08                      Ldaa #8
249e b1 10 0f                   Cmpa CONT_DIG
24a1 27 19                      Beq CONT_DIG_es_8
24a3 18 0c 10 19 00 01          Movb DISP1,PORTB
24a9 86 0e                      LDAA #$0E
24ab 18 0b 0e 02 58             MOVB #$0E,PTP   ;que hay en el nibble superior de P?
                        ;        Bset PTP,$0E     ;PTP.[3:0] <- $E
24b0 1c 02 68 02                Bset PTJ,$2
24b4                    Antes_de_retornar:
24b4 dc 44                      Ldd TCNT
24b6 c3 00 1e                   Addd #30
24b9 5c 58                      Std TC4
24bb 0b                         Rti
                        
24bc                    CONT_DIG_es_8:
24bc 18 0c 10 1a 00 01          Movb DISP2,PORTB
24c2 18 0b 0d 02 58             MOVB #$0D,PTP
                        ;        Bset PTP,$0D   ;PTP.[3:0] <- $D
24c7 1c 02 68 02                Bset PTJ,$2
24cb 20 e7                      Bra Antes_de_retornar
                        
24cd                    CONT_DIG_es_4:
24cd 18 0c 10 1b 00 01          Movb DISP3,PORTB
24d3 18 0b 0b 02 58             MOVB #$0B,PTP
                        ;        Bset PTP,$0B ;PTP.[3:0] <- $B
24d8 1c 02 68 02                Bset PTJ,$2
24dc 20 d6                      Bra Antes_de_retornar
                        
24de                    CONT_DIG_es_2:
24de 18 0c 10 1c 00 01          Movb DISP4,PORTB
24e4 18 0b 07 02 58             MOVB #$07,PTP
                        ;        Bset PTP,$07 ;PTP.[2:0] <- 7
24e9 1c 02 68 02                Bset PTJ,$2
24ed 20 c5                      Bra Antes_de_retornar
                        
24ef                    CONT_DIG_es_1:
24ef 18 0c 10 0d 00 01          Movb LEDS,PORTB
24f5 18 0b 0f 02 58             MOVB #$0F,PTP
                        ;        Bset PTP,$F
24fa 1d 02 68 02                BClr PTJ,$2
24fe 20 b4                      Bra Antes_de_retornar
                        
2500                    Portb_cero:
2500 18 0b 00 00 01             Movb #$0,PORTB
2505 20 ad                      Bra Antes_de_retornar
                        
                        
                        ;*******************************************************************************
                        ;                           SUBRUTINAS DE TAREA 4
                        ;*******************************************************************************
                        
                                                ;*******************************************************
2507                    Tarea_Teclado:          ;                      SUBRUTINA
                                                ;*******************************************************
                                                ;Verifica estado de teclas ingresadas
                                                   ;y llama a las otras subrutinas
                                                ;*******************************************************
                        ;        MOVB #$01,PORTB  ;debugging
                        ;        INC Print+1
2507 f7 10 04                   TST Cont_Reb
250a 26 44                      BNE Retorno_Tarea_Teclado
250c 16 25 51                   JSR Mux_Teclado
250f 1e 10 02 ff 30             BRSET Tecla,$FF,revisar_TCL_LISTA
                        
2514 1e 10 00 02 11             BRSET Banderas,$02,revisar_teclas
2519 18 0c 10 02 10 03          MOVB Tecla,Tecla_IN
251f 1c 10 00 02                BSET Banderas,$02
2523 18 0b 0a 10 04             MOVB #10,Cont_Reb
                        
2528 20 26                      BRA Retorno_Tarea_Teclado
                        
252a                    revisar_teclas:
252a b6 10 02                   LDAA Tecla
252d b1 10 03                   CMPA Tecla_IN
2530 26 06                      BNE error_al_leer
2532 1c 10 00 01                BSET Banderas,$01
2536 20 18                      BRA Retorno_Tarea_Teclado
                        
2538                    error_al_leer:
2538 18 03 ff ff 10 02          MOVW #$FFFF,Tecla ;Pone FF en las posiciones Tecla y Tecla_IN;
253e 1d 10 00 03                BCLR Banderas,$03
2542 20 0c                      BRA Retorno_Tarea_Teclado
                        
2544                    revisar_TCL_LISTA:
2544 1f 10 00 01 07             BRCLR Banderas,$01,Retorno_Tarea_Teclado
2549 1d 10 00 03                BCLR Banderas,$03
254d 16 25 94                   JSR Formar_Array
                        
2550                    Retorno_Tarea_Teclado:
2550 3d                         RTS
                        
                                                ;*******************************************************
2551                    Mux_Teclado:            ;                      SUBRUTINA
                                                ;*******************************************************
                                                ;Lee teclado matricial
                                                ;*******************************************************
                        ;        MOVB #$02,PORTB  ;debugging
                        ;        INC Print+2
2551 ce 10 26                   LDX #Teclas
2554 87                         CLRA
2555 18 0b ef 10 06             MOVB #$EF,Patron
255a                    loop_mux:
255a 18 0c 10 06 00 00          MOVB Patron,PORTA
2560 4f 00 02 2a                BRCLR PORTA,$02,tecla_presionada
2564 42                         INCA
2565 a7                         NOP
2566 a7                         NOP
2567 a7                         NOP
2568 a7                         NOP
2569 a7                         NOP
256a 4f 00 04 20                BRCLR PORTA,$04,tecla_presionada
256e 42                         INCA
256f a7                         NOP
2570 a7                         NOP
2571 a7                         NOP
2572 a7                         NOP
2573 a7                         NOP
2574 4f 00 08 16                BRCLR PORTA,$08,tecla_presionada
2578 42                         INCA
2579 a7                         NOP
257a a7                         NOP
257b a7                         NOP
257c a7                         NOP
257d a7                         NOP
257e 78 10 06                   LSL Patron
2581 1f 10 06 f0 02             BRCLR Patron,$F0,nada_presionado
2586 20 d2                      BRA loop_mux
                        
2588                    nada_presionado:
                        ;        Inc Print+6
2588 18 0b ff 10 02             MOVB #$FF,Tecla
258d 3d                         RTS
                        
258e                    tecla_presionada:
258e 18 0d e4 10 02             MOVB A,X,Tecla
                        ;        Inc Print+7
2593 3d                         RTS
                        
                                                ;*******************************************************
2594                    Formar_Array:           ;                      SUBRUTINA
                                                ;*******************************************************
                                                ;Llena arreglo Num_Array con teclas leidas
                                                ;*******************************************************
                        ;        MOVB #$04,PORTB  ;debugging
                        ;        INC Print+3
2594 ce 10 07                   Ldx #Num_Array   ; Cargar direcci?n de Num_Array en el ?ndice Y
2597 86 0b                      Ldaa #$0B
2599 f6 10 05                   Ldab Cont_TCL
                                ;Incb
259c f1 10 01                   Cmpb MAX_TCL
259f 27 4a                      Beq full_array
25a1 c6 0e                      Ldab #$0E
25a3 f7 10 05                   TST Cont_TCL
25a6 27 2c                      Beq primer_input
25a8 b1 10 03                   Cmpa Tecla_IN
25ab 27 1b                      Beq reducir_contador
25ad f1 10 03                   Cmpb Tecla_IN
25b0 27 0d                      Beq poner_array_ok
25b2 f6 10 05                   Ldab Cont_TCL
25b5 18 09 e5 10 03             Movb Tecla_IN,b,x ; No sabemos si est? bien
25ba 72 10 05                   Inc Cont_TCL
25bd 20 3a                      Bra Nodo_Final
                        
25bf                    poner_array_ok:
25bf 1c 10 00 04                Bset Banderas,$04 ;Poner en 1 el bit 3 (Array_Ok)
25c3 79 10 05                   Clr Cont_TCL
25c6 20 31                      Bra Nodo_Final
                        
25c8                    reducir_contador:
25c8 73 10 05                   Dec Cont_TCL
25cb f6 10 05                   Ldab Cont_TCL
25ce 18 08 e5 ff                Movb #$FF,b,x
25d2 20 25                      Bra Nodo_Final
                        
25d4                    primer_input:
25d4 b1 10 03                   Cmpa Tecla_IN
25d7 27 20                      Beq Nodo_Final
25d9 f1 10 03                   Cmpb Tecla_IN
25dc 27 1b                      Beq Nodo_Final
25de f6 10 05                   Ldab Cont_TCL
25e1 18 09 e5 10 03             Movb Tecla_IN,b,x
25e6 72 10 05                   Inc Cont_TCL
25e9 20 0e                      Bra Nodo_Final
                        
25eb                    full_array:
25eb c6 0e                      Ldab #$0E
25ed b1 10 03                   Cmpa Tecla_IN
25f0 27 d6                      beq reducir_contador
25f2 f1 10 03                   Cmpb Tecla_IN
25f5 27 c8                      Beq poner_array_ok
25f7 20 00                      Bra Nodo_Final
                        
25f9                    Nodo_Final:
25f9 18 0b ff 10 03             Movb #$FF,Tecla_IN
25fe 3d                         RTS

Executed: Sat Feb 13 00:24:31 2021
Total cycles: 1722, Total bytes: 1628
Total errors: 0, Total warnings: 0
